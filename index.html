<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM Multijoueur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
        
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .hidden { display: none !important; }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .timer-pulse {
            animation: timerPulse 1s infinite;
        }
        
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .correct-answer-big {
            animation: zoomIn 0.5s ease-out;
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .btn-hover {
            transition: all 0.3s ease;
        }
        
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="min-h-screen">
    
    <!-- √âcran de connexion -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass rounded-3xl p-8 max-w-md w-full shadow-2xl fade-in">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-bold text-white mb-2">QCM</h1>
                <p class="text-white/70 text-sm">by prolecteur</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-white font-semibold block mb-2">Pseudo</label>
                    <input type="text" id="pseudoInput" 
                        class="w-full px-4 py-3 rounded-xl glass text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50"
                        placeholder="Entrez votre pseudo">
                </div>

                <div>
                    <label class="text-white font-semibold block mb-2">Avatar</label>
                    <div id="avatarGrid" class="grid grid-cols-4 gap-2">
                        <!-- Avatars g√©n√©r√©s par JS -->
                    </div>
                </div>

                <div>
                    <label class="text-white font-semibold block mb-2">R√¥le</label>
                    <select id="roleSelect" class="w-full px-4 py-3 rounded-xl glass text-white font-bold focus:outline-none focus:ring-2 focus:ring-white/50">
                        <option value="player" class="bg-purple-800">Joueur</option>
                        <option value="host" class="bg-purple-800">H√¥te de partie</option>
                    </select>
                </div>

                <div id="playerCodeDiv" class="hidden">
                    <label class="text-white font-semibold block mb-2">Code de la Partie</label>
                    <input type="text" id="playerRoomCodeInput" 
                        class="w-full px-4 py-3 rounded-xl glass text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50"
                        placeholder="Ex: ABC123">
                </div>

                <button onclick="login()" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-4 rounded-xl hover:from-pink-600 hover:to-purple-700 transition shadow-lg btn-hover">
                    üöÄ Rejoindre
                </button>
            </div>
        </div>
    </div>

    <!-- √âcran Lobby -->
    <div id="lobbyScreen" class="hidden min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="glass rounded-3xl p-6 mb-6 shadow-xl">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <div class="text-5xl" id="userAvatar"></div>
                        <div>
                            <div class="text-white font-bold text-xl" id="userPseudo"></div>
                            <div class="text-white/60 text-sm" id="userRole"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="glass px-6 py-3 rounded-xl">
                            <div class="text-white/70 text-xs font-semibold">CODE SALLE</div>
                            <div class="text-white font-mono font-bold text-2xl" id="roomCode"></div>
                        </div>
                        <button onclick="logout()" class="p-4 bg-red-500/80 rounded-xl hover:bg-red-600 transition text-white btn-hover">
                            üö™
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid gap-6">
                <!-- Joueurs -->
                <div class="glass rounded-3xl p-6 shadow-xl">
                    <h2 class="text-3xl font-bold text-white mb-6">üë• Joueurs (<span id="playerCount">0</span>)</h2>
                    <div id="playersList" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Joueurs g√©n√©r√©s par JS -->
                    </div>
                    
                    <button onclick="startGameForAll()" id="startGameBtn" class="w-full mt-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-xl hover:from-green-600 hover:to-emerald-700 transition shadow-lg btn-hover hidden">
                        üéÆ LANCER LA PARTIE
                    </button>
                </div>

                <!-- Gestion des questions -->
                <div id="questionsPanel" class="glass rounded-3xl p-6 shadow-xl hidden">
                    <h2 class="text-3xl font-bold text-white mb-6">‚öôÔ∏è Questions (<span id="questionCount">0</span>)</h2>
                    
                    <!-- Import Excel -->
                    <div class="glass p-4 rounded-xl mb-6 border border-blue-400/50">
                        <p class="text-white font-bold mb-3">üìä Importer depuis Excel/CSV</p>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="hidden">
                        <button onclick="document.getElementById('excelFileInput').click()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition btn-hover">
                            üìÅ Choisir un fichier
                        </button>
                        <p class="text-white/60 text-xs mt-2">Format: Question | Opt1 | Opt2 | Opt3 | Opt4 | NumR√©ponse(1-4)</p>
                    </div>

                    <!-- Formulaire ajout question -->
                    <div class="space-y-3 mb-6">
                        <input type="text" id="questionInput" placeholder="Votre question..."
                            class="w-full px-4 py-3 rounded-xl glass text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex gap-2">
                                <input type="text" id="option0" placeholder="Option 1"
                                    class="flex-1 px-4 py-2 rounded-xl glass text-white placeholder-white/60 focus:outline-none">
                                <button onclick="selectCorrect(0)" id="correct0" class="px-4 py-2 rounded-xl bg-green-500 text-white font-bold">‚úì</button>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="option1" placeholder="Option 2"
                                    class="flex-1 px-4 py-2 rounded-xl glass text-white placeholder-white/60 focus:outline-none">
                                <button onclick="selectCorrect(1)" id="correct1" class="px-4 py-2 rounded-xl glass text-white/60 hover:bg-white/20">‚úì</button>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="option2" placeholder="Option 3"
                                    class="flex-1 px-4 py-2 rounded-xl glass text-white placeholder-white/60 focus:outline-none">
                                <button onclick="selectCorrect(2)" id="correct2" class="px-4 py-2 rounded-xl glass text-white/60 hover:bg-white/20">‚úì</button>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="option3" placeholder="Option 4"
                                    class="flex-1 px-4 py-2 rounded-xl glass text-white placeholder-white/60 focus:outline-none">
                                <button onclick="selectCorrect(3)" id="correct3" class="px-4 py-2 rounded-xl glass text-white/60 hover:bg-white/20">‚úì</button>
                            </div>
                        </div>
                        
                        <button onclick="addQuestion()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 rounded-xl hover:from-green-600 hover:to-emerald-700 transition btn-hover">
                            ‚ûï Ajouter Question
                        </button>
                    </div>

                    <!-- Liste des questions -->
                    <div id="questionsList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Questions g√©n√©r√©es par JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- √âcran de jeu -->
    <div id="gameScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="max-w-4xl w-full">
            <!-- Barre de progression -->
            <div class="glass rounded-3xl p-6 mb-6 shadow-xl">
                <div class="flex justify-between items-center text-white mb-4">
                    <div class="text-lg font-semibold">
                        Question <span id="currentQ">1</span> / <span id="totalQ">1</span>
                    </div>
                    <div class="text-3xl font-bold timer-pulse" id="timerDisplay">
                        ‚è±Ô∏è <span id="timer">7</span>s
                    </div>
                    <div class="text-lg font-bold">
                        Score: <span id="currentScore" class="text-yellow-400">0</span>
                    </div>
                </div>
                <div class="w-full bg-white/20 rounded-full h-3">
                    <div id="progressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Question et Options -->
            <div class="glass rounded-3xl p-8 shadow-2xl">
                <h2 id="questionText" class="text-4xl font-bold text-white mb-10 text-center"></h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="optionsGrid">
                    <!-- Options g√©n√©r√©es par JS -->
                </div>

                <!-- Affichage r√©ponses pour h√¥te -->
                <div id="hostAnswersDisplay" class="hidden mt-6 glass p-4 rounded-xl">
                    <p class="text-white font-bold mb-3 text-center">üëÄ R√©ponses en temps r√©el</p>
                    <div id="answersList" class="grid grid-cols-2 gap-3"></div>
                </div>

                <!-- Affichage bonne r√©ponse -->
                <div id="correctAnswerDisplay" class="hidden mt-8 p-10 bg-gradient-to-r from-green-400 to-emerald-500 rounded-3xl shadow-2xl correct-answer-big">
                    <p class="text-white text-center font-bold text-6xl mb-4">‚úÖ</p>
                    <p class="text-white text-center font-bold text-5xl mb-2">BONNE R√âPONSE</p>
                    <p class="text-white text-center font-bold text-4xl" id="correctAnswerText"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- √âcran r√©sultats -->
    <div id="resultsScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="max-w-3xl w-full glass rounded-3xl p-10 shadow-2xl">
            <h1 class="text-6xl font-bold text-white text-center mb-10">üèÜ CLASSEMENT FINAL üèÜ</h1>
            <div id="resultsList" class="space-y-4 mb-10">
                <!-- R√©sultats g√©n√©r√©s par JS -->
            </div>
            <button onclick="backToLobby()" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white font-bold py-4 rounded-xl hover:from-purple-600 hover:to-pink-700 transition shadow-lg btn-hover text-xl">
                üîÑ Retour au Lobby
            </button>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCdj_R6kKTH70wM3vu3Uzl_6tAy_ZzTKMw",
            authDomain: "qcm-fleau.firebaseapp.com",
            databaseURL: "https://qcm-fleau-default-rtdb.firebaseio.com",
            projectId: "qcm-fleau",
            storageBucket: "qcm-fleau.firebasestorage.app",
            messagingSenderId: "455524435079",
            appId: "1:455524435079:web:42c29a777879342ee7a422"
        };

        // Variables globales
        const AVATARS = ['üßô‚Äç‚ôÇÔ∏è', 'ü¶∏‚Äç‚ôÄÔ∏è', 'ü§ñ', 'üë®‚ÄçüöÄ', 'üßõ‚Äç‚ôÇÔ∏è', 'üßö‚Äç‚ôÄÔ∏è', 'ü¶π‚Äç‚ôÇÔ∏è', 'üëæ', 'ü¶Ñ', 'üêâ', 'ü¶Å', 'üêº'];
        
        let db = null;
        let currentUser = null;
        let roomCode = null;
        let isHost = false;
        let selectedAvatar = AVATARS[0];
        let correctAnswerIndex = 0;
        let timerInterval = null;
        let currentQuestionIndex = 0;
        let hasAnswered = false;
        let roomRef = null;
        let gameStarted = false;

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            firebase.initializeApp(FIREBASE_CONFIG);
            db = firebase.database();
            initAvatars();
            
            document.getElementById('roleSelect').addEventListener('change', (e) => {
                document.getElementById('playerCodeDiv').classList.toggle('hidden', e.target.value !== 'player');
            });

            document.getElementById('excelFileInput').addEventListener('change', handleFileUpload);
        });

        function initAvatars() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';
            AVATARS.forEach((avatar, idx) => {
                const btn = document.createElement('button');
                btn.className = 'text-4xl p-3 rounded-xl glass transition ' + (idx === 0 ? 'ring-2 ring-white scale-110' : 'hover:scale-110');
                btn.textContent = avatar;
                btn.onclick = () => selectAvatar(avatar, btn);
                grid.appendChild(btn);
            });
        }

        function selectAvatar(avatar, btn) {
            selectedAvatar = avatar;
            document.querySelectorAll('#avatarGrid button').forEach(b => {
                b.className = 'text-4xl p-3 rounded-xl glass transition hover:scale-110';
            });
            btn.className = 'text-4xl p-3 rounded-xl glass transition ring-2 ring-white scale-110';
        }

        function login() {
            const pseudo = document.getElementById('pseudoInput').value.trim();
            const role = document.getElementById('roleSelect').value;

            if (!pseudo) {
                alert('‚ö†Ô∏è Veuillez entrer un pseudo !');
                return;
            }

            isHost = (role === 'host');

            if (isHost) {
                roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                createRoom(pseudo);
            } else {
                const code = document.getElementById('playerRoomCodeInput').value.trim().toUpperCase();
                if (!code) {
                    alert('‚ö†Ô∏è Veuillez entrer le code de la partie !');
                    return;
                }
                joinRoom(code, pseudo);
            }
        }

        function createRoom(pseudo) {
            roomRef = db.ref('rooms/' + roomCode);
            
            currentUser = {
                id: Date.now().toString(),
                pseudo: pseudo,
                avatar: selectedAvatar,
                role: 'host',
                score: 0
            };

            const roomData = {
                code: roomCode,
                host: currentUser.id,
                players: {},
                questions: {},
                gameStarted: false,
                currentQuestion: -1,
                timeRemaining: 7
            };

            roomData.players[currentUser.id] = currentUser;

            roomRef.set(roomData).then(() => {
                document.getElementById('roomCode').textContent = roomCode;
                document.getElementById('questionsPanel').classList.remove('hidden');
                showScreen('lobbyScreen');
                listenToRoom();
            });
        }

        function joinRoom(code, pseudo) {
            roomCode = code;
            roomRef = db.ref('rooms/' + roomCode);

            roomRef.once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    alert('‚ùå Code invalide !');
                    return;
                }

                currentUser = {
                    id: Date.now().toString(),
                    pseudo: pseudo,
                    avatar: selectedAvatar,
                    role: 'player',
                    score: 0
                };

                roomRef.child('players').child(currentUser.id).set(currentUser).then(() => {
                    document.getElementById('roomCode').textContent = roomCode;
                    showScreen('lobbyScreen');
                    listenToRoom();
                });
            });
        }

        function listenToRoom() {
            roomRef.child('players').on('value', snapshot => {
                updatePlayersList(snapshot.val() || {});
            });

            roomRef.child('questions').on('value', snapshot => {
                updateQuestionsList(snapshot.val() || {});
            });

            roomRef.child('gameStarted').on('value', snapshot => {
                if (snapshot.val() === true && !gameStarted) {
                    gameStarted = true;
                    hasAnswered = false;
                    showScreen('gameScreen');
                } else if (snapshot.val() === false && gameStarted) {
                    // Le jeu vient de se terminer, afficher les r√©sultats pour tous
                    gameStarted = false;
                    setTimeout(() => showResults(), 500);
                }
            });

            roomRef.child('currentQuestion').on('value', snapshot => {
                const qIndex = snapshot.val();
                if (qIndex !== null && qIndex >= 0 && gameStarted) {
                    if (qIndex !== currentQuestionIndex) {
                        currentQuestionIndex = qIndex;
                        hasAnswered = false;
                        displayQuestion();
                    }
                }
            });

            roomRef.child('timeRemaining').on('value', snapshot => {
                const time = snapshot.val();
                if (time !== null && gameStarted) {
                    document.getElementById('timer').textContent = time;
                    
                    if (time === 0 && !hasAnswered) {
                        roomRef.child('questions').once('value', qSnap => {
                            const questions = Object.values(qSnap.val() || {});
                            if (questions[currentQuestionIndex]) {
                                showCorrectAnswerBig(questions[currentQuestionIndex]);
                            }
                        });
                    }
                }
            });

            if (isHost) {
                roomRef.child('answers').on('value', snapshot => {
                    if (gameStarted) {
                        displayPlayerAnswers(snapshot.val() || {});
                    }
                });
            }
        }

        function updatePlayersList(players) {
            const list = document.getElementById('playersList');
            document.getElementById('playerCount').textContent = Object.keys(players).length;
            
            if (currentUser) {
                document.getElementById('userAvatar').textContent = currentUser.avatar;
                document.getElementById('userPseudo').textContent = currentUser.pseudo + (isHost ? ' üõ°Ô∏è' : '');
                document.getElementById('userRole').textContent = isHost ? 'H√¥te' : 'Joueur';
            }

            list.innerHTML = '';
            Object.values(players).forEach(player => {
                const div = document.createElement('div');
                div.className = 'glass rounded-xl p-4 flex items-center justify-between btn-hover';
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="text-4xl">${player.avatar}</div>
                        <div>
                            <div class="text-white font-bold text-lg">${player.pseudo} ${player.role === 'host' ? 'üõ°Ô∏è' : ''}</div>
                            <div class="text-white/60 text-sm">${player.role === 'host' ? 'H√¥te' : 'Joueur'}</div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });

            roomRef.child('questions').once('value', snapshot => {
                if (isHost && Object.keys(snapshot.val() || {}).length > 0) {
                    document.getElementById('startGameBtn').classList.remove('hidden');
                }
            });
        }

        function selectCorrect(idx) {
            correctAnswerIndex = idx;
            for (let i = 0; i < 4; i++) {
                const btn = document.getElementById(`correct${i}`);
                btn.className = i === idx ? 
                    'px-4 py-2 rounded-xl bg-green-500 text-white font-bold' : 
                    'px-4 py-2 rounded-xl glass text-white/60 hover:bg-white/20';
            }
        }

        function addQuestion() {
            if (!isHost) return;

            const question = document.getElementById('questionInput').value.trim();
            const options = [
                document.getElementById('option0').value.trim(),
                document.getElementById('option1').value.trim(),
                document.getElementById('option2').value.trim(),
                document.getElementById('option3').value.trim()
            ];

            if (!question || options.some(opt => !opt)) {
                alert('‚ö†Ô∏è Remplissez tous les champs !');
                return;
            }

            const questionId = Date.now().toString();
            roomRef.child('questions').child(questionId).set({
                id: questionId,
                question: question,
                options: options,
                correct: correctAnswerIndex
            }).then(() => {
                document.getElementById('questionInput').value = '';
                for (let i = 0; i < 4; i++) {
                    document.getElementById(`option${i}`).value = '';
                }
                selectCorrect(0);
            });
        }

        function deleteQuestion(questionId) {
            if (confirm('Supprimer cette question ?')) {
                roomRef.child('questions').child(questionId).remove();
            }
        }

        function updateQuestionsList(questions) {
            document.getElementById('questionCount').textContent = Object.keys(questions).length;
            
            const list = document.getElementById('questionsList');
            list.innerHTML = '';
            
            Object.values(questions).forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'glass rounded-xl p-4 flex items-center justify-between';
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="text-white font-semibold">${idx + 1}. ${q.question}</div>
                        <div class="text-white/60 text-sm mt-1">‚úì ${q.options[q.correct]}</div>
                    </div>
                    ${isHost ? `<button onclick="deleteQuestion('${q.id}')" class="ml-4 p-2 bg-red-500/80 rounded-lg hover:bg-red-600 transition text-white">üóëÔ∏è</button>` : ''}
                `;
                list.appendChild(div);
            });

            if (isHost && Object.keys(questions).length > 0) {
                document.getElementById('startGameBtn').classList.remove('hidden');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    let count = 0;
                    jsonData.forEach((row, i) => {
                        if (row.length >= 6 && row[0] && row[1] && row[2] && row[3] && row[4]) {
                            const correctNum = parseInt(row[5]);
                            if (correctNum >= 1 && correctNum <= 4) {
                                const qId = Date.now().toString() + '_' + i;
                                roomRef.child('questions').child(qId).set({
                                    id: qId,
                                    question: row[0].toString(),
                                    options: [row[1].toString(), row[2].toString(), row[3].toString(), row[4].toString()],
                                    correct: correctNum - 1
                                });
                                count++;
                            }
                        }
                    });

                    alert(count > 0 ? `‚úÖ ${count} questions import√©es !` : '‚ùå Aucune question valide');
                    event.target.value = '';
                } catch (error) {
                    alert('‚ùå Erreur: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function startGameForAll() {
            if (!isHost) return;
            
            roomRef.child('answers').remove();
            roomRef.update({
                gameStarted: true,
                currentQuestion: 0,
                timeRemaining: 7
            }).then(() => {
                startHostTimer();
            });
        }

        function startHostTimer() {
            if (!isHost) return;
            if (timerInterval) clearInterval(timerInterval);
            
            let time = 7;
            roomRef.update({ timeRemaining: time });
            
            timerInterval = setInterval(() => {
                time--;
                roomRef.update({ timeRemaining: time });
                
                if (time <= 0) {
                    clearInterval(timerInterval);
                    
                    setTimeout(() => {
                        roomRef.child('answers').child('q' + currentQuestionIndex).remove();
                        
                        roomRef.child('questions').once('value', snapshot => {
                            const questions = Object.values(snapshot.val() || {});
                            
                            if (currentQuestionIndex < questions.length - 1) {
                                roomRef.update({ 
                                    currentQuestion: currentQuestionIndex + 1,
                                    timeRemaining: 7
                                }).then(() => startHostTimer());
                            } else {
                                roomRef.update({ gameStarted: false, currentQuestion: -1 });
                                setTimeout(() => showResults(), 500);
                            }
                        });
                    }, 3000);
                }
            }, 1000);
        }

        function displayQuestion() {
            document.getElementById('correctAnswerDisplay').classList.add('hidden');
            document.getElementById('optionsGrid').style.display = 'grid';
            document.getElementById('questionText').style.display = 'block';
            
            if (isHost) {
                document.getElementById('hostAnswersDisplay').classList.remove('hidden');
                document.getElementById('answersList').innerHTML = '<p class="text-white/60 text-sm col-span-2 text-center">En attente...</p>';
            }
            
            roomRef.child('questions').once('value', snapshot => {
                const questions = Object.values(snapshot.val() || {});
                
                if (currentQuestionIndex >= questions.length) {
                    showResults();
                    return;
                }
                
                const q = questions[currentQuestionIndex];
                document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
                document.getElementById('totalQ').textContent = questions.length;
                
                roomRef.child('players').child(currentUser.id).once('value', pSnapshot => {
                    const playerData = pSnapshot.val();
                    document.getElementById('currentScore').textContent = playerData.score || 0;
                });
                
                document.getElementById('progressBar').style.width = ((currentQuestionIndex + 1) / questions.length * 100) + '%';
                document.getElementById('questionText').textContent = q.question;

                const grid = document.getElementById('optionsGrid');
                grid.innerHTML = '';
                
                q.options.forEach((option, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'glass text-white font-bold py-6 px-6 rounded-2xl hover:bg-white/30 transition transform hover:scale-105 text-lg';
                    btn.textContent = option;
                    btn.onclick = () => answerQuestion(idx, btn, q);
                    grid.appendChild(btn);
                });
            });
        }

        function answerQuestion(idx, btn, question) {
            if (hasAnswered) return;
            hasAnswered = true;

            const isCorrect = idx === question.correct;

            document.querySelectorAll('#optionsGrid button').forEach(b => {
                b.disabled = true;
                b.classList.remove('hover:scale-105', 'hover:bg-white/30');
            });

            if (isCorrect) {
                btn.className = 'bg-green-500 text-white font-bold py-6 px-6 rounded-2xl text-lg';
                
                roomRef.child('players').child(currentUser.id).once('value', snapshot => {
                    const player = snapshot.val();
                    const newScore = (player.score || 0) + 1;
                    roomRef.child('players').child(currentUser.id).update({ score: newScore });
                    document.getElementById('currentScore').textContent = newScore;
                });
            } else {
                btn.className = 'bg-red-500 text-white font-bold py-6 px-6 rounded-2xl text-lg';
            }

            roomRef.child('answers').child('q' + currentQuestionIndex).child(currentUser.id).set({
                answer: idx,
                avatar: currentUser.avatar,
                pseudo: currentUser.pseudo,
                isCorrect: isCorrect
            });
        }

        function displayPlayerAnswers(answersData) {
            if (!isHost) return;
            
            const currentAnswers = answersData['q' + currentQuestionIndex] || {};
            const answersList = document.getElementById('answersList');
            
            if (Object.keys(currentAnswers).length === 0) {
                answersList.innerHTML = '<p class="text-white/60 text-sm col-span-2 text-center">En attente...</p>';
                return;
            }
            
            const grouped = { 0: [], 1: [], 2: [], 3: [] };
            Object.values(currentAnswers).forEach(data => {
                grouped[data.answer].push(data);
            });
            
            answersList.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const div = document.createElement('div');
                div.className = 'glass p-3 rounded-lg';
                
                const avatars = grouped[i].map(a => a.avatar).join(' ');
                const count = grouped[i].length;
                
                div.innerHTML = `
                    <div class="text-white/60 text-xs mb-1 font-semibold">Option ${i + 1}</div>
                    <div class="text-2xl">${avatars || '‚Äî'}</div>
                    <div class="text-white text-sm mt-1">${count} r√©ponse(s)</div>
                `;
                answersList.appendChild(div);
            }
        }

        function showCorrectAnswerBig(question) {
            document.getElementById('optionsGrid').style.display = 'none';
            document.getElementById('questionText').style.display = 'none';
            document.getElementById('correctAnswerText').textContent = question.options[question.correct];
            document.getElementById('correctAnswerDisplay').classList.remove('hidden');
        }

        function showResults() {
            if (timerInterval) clearInterval(timerInterval);
            gameStarted = false;
            showScreen('resultsScreen');
            
            roomRef.child('players').once('value', snapshot => {
                const players = Object.values(snapshot.val() || {});
                const sorted = players.sort((a, b) => (b.score || 0) - (a.score || 0));
                
                const list = document.getElementById('resultsList');
                list.innerHTML = '';
                
                const positions = ['1er', '2√®me', '3√®me'];
                
                sorted.forEach((player, idx) => {
                    const div = document.createElement('div');
                    let bgClass = 'glass';
                    let medal = '';
                    let posText = positions[idx] || `${idx + 1}√®me`;
                    
                    if (idx === 0) {
                        bgClass = 'bg-gradient-to-r from-yellow-400 to-yellow-600';
                        medal = 'ü•á';
                    } else if (idx === 1) {
                        bgClass = 'bg-gradient-to-r from-gray-300 to-gray-500';
                        medal = 'ü•à';
                    } else if (idx === 2) {
                        bgClass = 'bg-gradient-to-r from-orange-400 to-orange-600';
                        medal = 'ü•â';
                    }
                    
                    div.className = `${bgClass} rounded-2xl p-6 flex items-center justify-between transform transition hover:scale-105 shadow-xl`;
                    div.innerHTML = `
                        <div class="flex items-center gap-6">
                            <div class="text-4xl font-bold ${idx < 3 ? 'text-white' : 'text-white/80'}">${posText}</div>
                            <div class="text-6xl">${player.avatar}</div>
                            <div>
                                <div class="${idx < 3 ? 'text-white' : 'text-white'} font-bold text-2xl">${player.pseudo}</div>
                                <div class="${idx < 3 ? 'text-white/90' : 'text-white/70'} text-xl font-semibold">${player.score || 0} point${(player.score || 0) > 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        ${medal ? `<span class="text-7xl">${medal}</span>` : ''}
                    `;
                    list.appendChild(div);
                });
            });
        }

        function backToLobby() {
            if (timerInterval) clearInterval(timerInterval);
            
            if (isHost) {
                roomRef.update({
                    gameStarted: false,
                    currentQuestion: -1,
                    timeRemaining: 7
                });
                
                roomRef.child('answers').remove();
                
                roomRef.child('players').once('value', snapshot => {
                    const players = snapshot.val() || {};
                    Object.keys(players).forEach(playerId => {
                        roomRef.child('players').child(playerId).update({ score: 0 });
                    });
                });
            }
            
            currentQuestionIndex = 0;
            gameStarted = false;
            hasAnswered = false;
            showScreen('lobbyScreen');
        }

        function logout() {
            if (timerInterval) clearInterval(timerInterval);
            
            if (currentUser && roomRef) {
                roomRef.child('players').child(currentUser.id).remove();
                if (isHost) roomRef.remove();
            }
            
            currentUser = null;
            roomCode = null;
            isHost = false;
            gameStarted = false;
            showScreen('loginScreen');
        }

        function showScreen(screenId) {
            ['loginScreen', 'lobbyScreen', 'gameScreen', 'resultsScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }
    </script>
</body>
</html>
